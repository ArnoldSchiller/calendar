    /* ============================================================
     * NAVIGATION BAR – MONTH / YEAR SELECTOR
     * ============================================================
     *
     * This section renders the top navigation bar of the calendar.
     *
     * ────────────────────────────────────────────────────────────
     * CONTEXT / PRECONDITIONS
     * ────────────────────────────────────────────────────────────
     *
     * At this point in execution, the following is already true:
     *
     * 1. This class is a Cinnamon applet view written in TypeScript,
     *    compiled to GJS-compatible JavaScript.
     *
     * 2. `this.navBox` is a St.BoxLayout that already exists and is
     *    dedicated exclusively to holding the navigation bar UI.
     *
     * 3. The following state variables are already initialized and valid:
     *    - this.displayedYear   (number)
     *    - this.displayedMonth  (0–11, JavaScript Date convention)
     *    - this.selectedDay    (number | null)
     *    - this.currentView    ("MONTH" | "DAY" | "YEAR")
     *
     * 4. The following helper methods already exist and work:
     *    - scrollMonth(delta)
     *    - scrollYear(delta)
     *    - render()
     *
     * 5. Cinnamon's St (Shell Toolkit) namespace is available and imported,
     *    providing BoxLayout, Button, Label, alignment constants, etc.
     *
     * The navigation bar itself is stateless UI: it does NOT store state,
     * it only manipulates the existing calendar state and triggers re-rendering.
     *
     * ────────────────────────────────────────────────────────────
     * VISUAL STRUCTURE
     * ────────────────────────────────────────────────────────────
     *
     * [ < ]  [ Month Name ]  [ > ]     [ spacer ]     [ < ] [ Year ] [ > ]
     *
     * - Left side:   Month navigation
     * - Center:      Reserved space (future messages / indicators)
     * - Right side:  Year navigation
     *
     * ────────────────────────────────────────────────────────────
     */

    private renderNav(): void {
        // Remove all previously rendered navigation elements.
        // This ensures a clean rebuild on every render() call.
        this.navBox.destroy_children();

        // Root container for the navigation bar.
        // All sub-components (month, spacer, year) are placed inside.
        const navContainer = new St.BoxLayout({
            style_class: "calendar",
            x_align: St.Align.MIDDLE,
        });

        /* ========================================================
         * MONTH SELECTOR (LEFT SIDE)
         * ========================================================
         *
         * Allows navigating backward / forward by one month.
         * The month name itself is clickable and switches to
         * MONTH view when clicked.
         */

        const monthBox = new St.BoxLayout({ style: "margin-right: 5px;" });

        // Button: previous month
        const btnPrevM = new St.Button({
            label: "‹",
            style_class: "calendar-change-month-back",
        });

        // Decrease month by one and re-render
        btnPrevM.connect("clicked", () => this.scrollMonth(-1));

        // Button displaying the current month name
        const monthBtn = new St.Button({
            label: new Date(
                this.displayedYear,
                this.displayedMonth
            ).toLocaleString(this.LOCALE, { month: "long" }),

            style_class: "calendar-month-label",
            reactive: true,
            x_expand: true,
            x_fill: true,

            // We explicitly force transparency and remove default
            // button padding to visually behave like a label.
            style:
                "padding: 2px 0; " +
                "background-color: transparent; " +
                "border: none; " +
                "min-width: 140px; " +
                "text-align: center;",
        });

        // Clicking the month name switches explicitly to MONTH view.
        // This is useful when coming from DAY or YEAR view.
        monthBtn.connect("clicked", () => {
            this.currentView = "MONTH";
            this.render();
        });

        // Button: next month
        const btnNextM = new St.Button({
            label: "›",
            style_class: "calendar-change-month-forward",
        });

        // Increase month by one and re-render
        btnNextM.connect("clicked", () => this.scrollMonth(1));

        // Assemble month selector
        monthBox.add_actor(btnPrevM);
        monthBox.add_actor(monthBtn);
        monthBox.add_actor(btnNextM);

        /* ========================================================
         * MIDDLE SPACER (CENTER)
         * ========================================================
         *
         * Currently unused.
         * This spacer keeps the layout visually balanced and
         * allows future extensions (messages, sync status, etc.)
         * without redesigning the navigation bar.
         *
         * TODO: Replace with meaningful status indicators
         */

        const middleBox = new St.BoxLayout({
            x_expand: true,
        });

        // Non-breaking spaces used to enforce minimum width.
        const middleLabel = new St.Label({
            text:
                "\u00A0\u00A0\u00A0\u00A0\u00A0\u00A0\u00A0\u00A0" +
                "\u00A0\u00A0\u00A0\u00A0\u00A0\u00A0\u00A0\u00A0" +
                "\u00A0\u00A0\u00A0\u00A0",
            style_class: "calendar-month-label",
            style: "min-width: 50px; text-align: center;",
        });

        middleBox.add_actor(middleLabel);

        /* ========================================================
         * YEAR SELECTOR (RIGHT SIDE)
         * ========================================================
         *
         * Allows navigating backward / forward by one year.
         * Clicking the year switches to YEAR overview.
         */

        const yearBox = new St.BoxLayout({
            style: "margin-left: 5px;",
        });

        // Button: previous year
        const btnPrevY = new St.Button({
            label: "‹",
            style_class: "calendar-change-month-back",
        });

        btnPrevY.connect("clicked", () => this.scrollYear(-1));

        // Button displaying the current year
        const yearBtn = new St.Button({
            label: this.displayedYear.toString(),
            style_class: "calendar-month-label",
            x_expand: true,
            reactive: true,
        });

        // Switch to YEAR view
        yearBtn.connect("clicked", () => {
            this.currentView = "YEAR";
            this.render();
        });

        // Button: next year
        const btnNextY = new St.Button({
            label: "›",
            style_class: "calendar-change-month-forward",
        });

        btnNextY.connect("clicked", () => this.scrollYear(1));

        // Assemble year selector
        yearBox.add_actor(btnPrevY);
        yearBox.add_actor(yearBtn);
        yearBox.add_actor(btnNextY);

        // Assemble full navigation bar
        navContainer.add_actor(monthBox);
        navContainer.add_actor(middleBox);
        navContainer.add_actor(yearBox);

        this.navBox.add_actor(navContainer);
    }

    /* ============================================================
     * YEAR / MONTH SCROLL HELPERS
     * ============================================================
     *
     * These helpers modify the calendar's temporal context
     * and immediately trigger a re-render.
     *
     * They also reset selectedDay to avoid invalid state
     * when switching months or years.
     */

    private scrollYear(delta: number): void {
        this.displayedYear += delta;
        this.selectedDay = null;
        this.render();
    }

    private scrollMonth(delta: number): void {
        const d = new Date(
            this.displayedYear,
            this.displayedMonth + delta,
            1
        );

        this.selectedDay = null;
        this.displayedYear = d.getFullYear();
        this.displayedMonth = d.getMonth();
        this.render();
    }

    /* ============================================================
     * EXTERNAL VIEW SYNCHRONIZATION
     * ============================================================
     *
     * Keeps the EventListView (if enabled) in sync with the
     * currently displayed calendar context.
     *
     * This method acts as a bridge between:
     * - CalendarView (date navigation)
     * - EventListView (list-based representation)
     */

    private _updateExternalViews() {
        if (!this.applet.showEvents || !this.applet.eventListView) return;

        const elv = this.applet.eventListView;

        if (this.currentView === "DAY" || this.selectedDay !== null) {
            // A specific day is selected → show day details
            const targetDate = new Date(
                this.displayedYear,
                this.displayedMonth,
                this.selectedDay || 1
            );

            const events =
                this.applet.eventManager.getEventsForDate(targetDate);

            elv.updateForDate(targetDate, events);
        } else {
            // No specific day → show month overview
            const events =
                this.applet.eventManager.getEventsForMonth(
                    this.displayedYear,
                    this.displayedMonth
                );

            elv.updateForMonth(
                this.displayedYear,
                this.displayedMonth,
                events
            );
        }
    }

    /* ============================================================
     * EXTERNAL NAVIGATION ENTRY POINT
     * ============================================================
     *
     * Allows external components (e.g. EventListView)
     * to request navigation to a specific date.
     */

    public jumpToDate(date: Date): void {
        this.displayedYear = date.getFullYear();
        this.displayedMonth = date.getMonth();
        this.selectedDay = date.getDate();
        this.currentView = "DAY";
        this.render();
    }

    /* ============================================================
     * CENTRAL RENDER DISPATCHER
     * ============================================================
     *
     * This is the single entry point for rendering.
     * It rebuilds navigation, content, footer and
     * synchronizes external views.
     */

    public render(): void {
        this.renderNav();
        this.contentBox.destroy_children();

        switch (this.currentView) {
            case "DAY":
                this.renderDayView();
                break;
            case "YEAR":
                this.renderYearView();
                break;
            default:
                this.renderMonthView();
                break;
        }

        const footer = new St.BoxLayout({
            style_class: "calendar-footer",
        });

        this.contentBox.add_actor(footer);

        this._updateExternalViews();
    }

